<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P√°gina de clientes</title>
    <style>
        #status-indicator {
            position: fixed; top: 10px; right: 10px; 
            padding: 5px 10px; border-radius: 5px; 
            font-size: 12px; z-index: 10000;
            background: #28a745; color: white;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <h1>Bienvenido a Salesmind</h1>
    <p>Tu asesor de confianza</p>

    <style>
        #chat-bubble {
            position: fixed; bottom: 25px; right: 25px; background-color: #7a5c43;
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.2s ease-in-out;
        }
        #chat-bubble:hover { transform: scale(1.1); }
        #chat-window {
            position: fixed; bottom: 100px; right: 25px; width: 350px;
            height: 500px; background-color: #fff; border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: none;
            flex-direction: column; overflow: hidden; font-family: Arial, sans-serif;
        }
        #chat-header {
            background-color: #7a5c43; color: white; padding: 15px;
            font-weight: bold; text-align: center;
        }
        #chat-messages {
            flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column;
        }
        .message {
            padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; max-width: 85%;
            line-height: 1.4;
        }
        .user-message { background-color: #f1f0f0; align-self: flex-end; }
        .bot-message { background-color: #7a5c43; color: white; align-self: flex-start; }
        #chat-input-container { display: flex; border-top: 1px solid #eee; padding: 10px; }
        #chat-input {
            flex-grow: 1; border: 1px solid #ddd; border-radius: 20px;
            padding: 10px 15px; outline: none; font-size: 14px;
        }
        #send-button {
            background: #7a5c43; color: white; border: none; border-radius: 50%;
            width: 40px; height: 40px; margin-left: 10px; cursor: pointer; font-size: 18px;
        }
    </style>
    
    <div id="salesmind-widget-container">
        <div id="chat-bubble">‚òï</div>
        <div id="chat-window">
            <div id="chat-header">SalesMind - Asistente Inmobiliario</div>
            <div id="chat-messages">
                <div class="message bot-message">¬°Hola! Soy SalesMind, tu asistente inmobiliario. Puedo ayudarte con informaci√≥n de propiedades y generar cotizaciones en PDF. ¬øEn qu√© puedo ayudarte?</div>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Escribe tu pregunta...">
                <button id="send-button">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        const API_HOST = "http://127.0.0.1:5000"; // La URL donde corre tu app Flask
        const CLIENT_PUBLIC_ID = "78e5f512-0a21-407b-819a-b5f02a091aac"; // Cliente de prueba con cotizaciones

        // --- L√ìGICA DEL CHAT ---
        const chatBubble = document.getElementById('chat-bubble');
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        chatBubble.addEventListener('click', () => {
            chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
        });

        const sendMessage = async (e) => {
            try {
                // üõ°Ô∏è PREVENCI√ìN TOTAL DE NAVEGACI√ìN
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
                
                const messageText = chatInput.value.trim();
                if (messageText === '') return;
                
                console.log('üì§ Enviando mensaje:', messageText);
                
                // üõ°Ô∏è ACTUALIZAR INDICADOR
                const statusIndicator = document.getElementById('status-indicator');
                if (statusIndicator) {
                    statusIndicator.textContent = 'üîÑ ENVIANDO...';
                    statusIndicator.style.background = '#ffc107';
                }
                
                appendMessage(messageText, 'user-message');
                chatInput.value = '';
                chatInput.disabled = true;
                sendButton.disabled = true;

                // üõ°Ô∏è FETCH CON PROTECCI√ìN ANTI-REDIRECT
                const response = await fetch(`${API_HOST}/chat-api`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ message: messageText, clientId: CLIENT_PUBLIC_ID }),
                    redirect: 'error' // üõ°Ô∏è NO seguir redirecciones
                });
                
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                appendMessage(data.reply, 'bot-message');
                
                // üõ°Ô∏è RESTAURAR INDICADOR
                if (statusIndicator) {
                    statusIndicator.textContent = '‚úÖ ENVIADO';
                    statusIndicator.style.background = '#28a745';
                }
                
            } catch (error) {
                console.error('‚ùå Error completo:', error);
                appendMessage('Lo siento, hubo un problema de conexi√≥n.', 'bot-message');
                
                const statusIndicator = document.getElementById('status-indicator');
                if (statusIndicator) {
                    statusIndicator.textContent = '‚ùå ERROR';
                    statusIndicator.style.background = '#dc3545';
                }
            } finally {
                chatInput.disabled = false;
                sendButton.disabled = false;
                chatInput.focus();
                
                // üõ°Ô∏è RESTAURAR INDICADOR DESPU√âS DE 2 SEG
                setTimeout(() => {
                    const statusIndicator = document.getElementById('status-indicator');
                    if (statusIndicator) {
                        statusIndicator.textContent = 'üõ°Ô∏è ANTI-REFRESH ACTIVO';
                        statusIndicator.style.background = '#28a745';
                    }
                }, 2000);
            }
        };

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // ‚úÖ PREVENIR REFRESH
                sendMessage();
            }
        });

        function appendMessage(text, className) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', className);
            
            // Permitir HTML solo para mensajes del bot (para enlaces de PDF)
            if (className === 'bot-message') {
                // Convertir enlaces de markdown a HTML
                const htmlText = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (match, linkText, url) => {
                    return `<span style="color: #FFD700; text-decoration: underline; cursor: pointer; padding: 5px; background: rgba(255,215,0,0.1); border-radius: 3px;" onclick="handleSafeDownload('${url}', '${linkText}')">${linkText}</span>`;
                });
                
                // üõ°Ô∏è FUNCI√ìN DE DESCARGA SEGURA
                window.handleSafeDownload = function(url, filename) {
                    try {
                        console.log('üì• Descarga segura:', url);
                        const tempLink = document.createElement('a');
                        tempLink.style.display = 'none';
                        tempLink.href = url;
                        tempLink.download = filename || '';
                        tempLink.target = '_blank';
                        tempLink.rel = 'noopener noreferrer';
                        document.body.appendChild(tempLink);
                        tempLink.click();
                        document.body.removeChild(tempLink);
                        
                        const statusIndicator = document.getElementById('status-indicator');
                        if (statusIndicator) {
                            statusIndicator.textContent = 'üì• DESCARGANDO';
                            statusIndicator.style.background = '#17a2b8';
                            setTimeout(() => {
                                statusIndicator.textContent = 'üõ°Ô∏è ANTI-REFRESH ACTIVO';
                                statusIndicator.style.background = '#28a745';
                            }, 2000);
                        }
                    } catch (error) {
                        console.error('‚ùå Error descarga:', error);
                        window.open(url, '_blank', 'noopener,noreferrer');
                    }
                };
                msgDiv.innerHTML = htmlText;
            } else {
                msgDiv.textContent = text;
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // üõ°Ô∏è PROTECCIONES GLOBALES ANTI-REFRESH
        
        // Capturar TODOS los errores
        window.addEventListener('error', (e) => {
            console.error('üí• ERROR GLOBAL:', e.error);
            const statusIndicator = document.getElementById('status-indicator');
            if (statusIndicator) {
                statusIndicator.textContent = '‚ö†Ô∏è ERROR DETECTADO';
                statusIndicator.style.background = '#dc3545';
            }
        });
        
        // Capturar promesas rechazadas
        window.addEventListener('unhandledrejection', (e) => {
            console.error('üí• PROMISE REJECTION:', e.reason);
            e.preventDefault(); // üõ°Ô∏è Prevenir navegaci√≥n por error
        });
        
        // üõ°Ô∏è PREVENIR SUBMIT GLOBAL
        document.addEventListener('submit', (e) => {
            console.log('üö´ SUBMIT DETECTADO Y CANCELADO');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
        });
        
        // üõ°Ô∏è TRIPLE PROTECCI√ìN KEYDOWN
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
            }
        });
        
        console.log('üõ°Ô∏è PROTECCIONES ANTI-REFRESH ACTIVAS');
        
    </script>
    </body>
</html>